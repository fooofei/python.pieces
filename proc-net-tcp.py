#!/usr/bin/env python3
# coding=utf-8

'''
解码 /proc/net/tcp 文件中的数据

代码引用 https://gist.github.com/aleiphoenix/0e886336522c2f41412d
'''

import os
import sys
import re


def split_every_n(data, n):
    return [data[i:i + n] for i in range(0, len(data), n)]


def convert_linux_netaddr(address):
    hex_addr, hex_port = address.split(':')

    addr_list = split_every_n(hex_addr, 2)
    addr_list.reverse()

    addr = ".".join(map(lambda x: str(int(x, 16)), addr_list))
    port = str(int(hex_port, 16))

    return "{}:{}".format(addr, port)


def format_line(data):
    return "%(seq)-4s %(uid)5s %(local)25s %(remote)25s %(timeout)8s %(inode)8s\n" % data


def main():
    columns = ("seq", "uid", "inode", "local", "remote", "timeout")
    title = dict()
    for c in columns:
        title[c] = c

    body = '''
   0: 0100007F:7B2A 00000000:0000 0A 00000000:00000000 00:00000000 00000000  1001        0 1289245124 1 ffff92c47c4b7380 100 0 0 10 0
   1: 00000000:1F90 00000000:0000 0A 00000000:00000000 00:00000000 00000000  1001        0 1289244277 1 ffff92c4f700e300 100 0 0 10 0
   2: 8F410E0A:CB1E CEFA030A:192C 06 00000000:00000000 03:00000455 00000000     0        0 0 3 ffff92c345828800
   3: 8F410E0A:CDBA CEFA030A:192C 06 00000000:00000000 03:00000BA0 00000000     0        0 0 3 ffff92bebba47300
   4: 8F410E0A:C612 CEFA030A:192C 06 00000000:00000000 03:00000000 00000000     0        0 0 3 ffff92bed0d10200
   5: 8F410E0A:CFEE CEFA030A:192C 06 00000000:00000000 03:000011A8 00000000     0        0 0 3 ffff92bebba46c00
   6: 8F410E0A:CDBE CEFA030A:192C 06 00000000:00000000 03:00000BA3 00000000     0        0 0 3 ffff92bed0d11800
   7: 8F410E0A:1F90 66060E0A:AF78 01 00000000:00000000 02:000004F2 00000000  1001        0 1301531376 2 ffff92c3375e4a40 20 4 29 10 -1
   8: 8F410E0A:C83A CEFA030A:192C 06 00000000:00000000 03:00000000 00000000     0        0 0 3 ffff92bed0d10f00
   9: 8F410E0A:C614 CEFA030A:192C 06 00000000:00000000 03:00000000 00000000     0        0 0 3 ffff92bed0d11400
  10: 8F410E0A:CC70 CEFA030A:192C 06 00000000:00000000 03:000007FF 00000000     0        0 0 3 ffff92bd3633e800
  11: 8F410E0A:CB50 8F1E020A:520F 01 00000000:00000000 02:00000065 00000000  1001        0 1289244259 2 ffff92c4f700d280 20 4 24 10 7
  12: 8F410E0A:CB08 CEFA030A:192C 06 00000000:00000000 03:00000421 00000000     0        0 0 3 ffff92c47a32a500
  13: 8F410E0A:D120 CEFA030A:192C 06 00000000:00000000 03:0000147D 00000000     0        0 0 3 ffff92bed0d10d00
  14: 8F410E0A:C996 CEFA030A:192C 06 00000000:00000000 03:0000002A 00000000     0        0 0 3 ffff92bed0d11700
  15: 8F410E0A:CFA4 CEFA030A:192C 06 00000000:00000000 03:000010EA 00000000     0        0 0 3 ffff92c4fafcfc00
  16: 8F410E0A:CFEC CEFA030A:192C 06 00000000:00000000 03:000011A5 00000000     0        0 0 3 ffff92bd3633e900
  17: 8F410E0A:D122 CEFA030A:192C 06 00000000:00000000 03:00001482 00000000     0        0 0 3 ffff92c33d775000
  18: 0100007F:7B2A 0100007F:822E 01 00000000:00000000 00:00000000 00000000  1001        0 1289246978 1 ffff92c47c4b4a40 21 4 29 10 -1
  19: 8F410E0A:C6C0 CEFA030A:192C 06 00000000:00000000 03:00000000 00000000     0        0 0 3 ffff92c33d774600
  20: 8F410E0A:C842 CEFA030A:192C 06 00000000:00000000 03:00000000 00000000     0        0 0 3 ffff92c4fafcea00
  21: 8F410E0A:C90E CEFA030A:192C 06 00000000:00000000 03:00000000 00000000     0        0 0 3 ffff92bebba46a00
  22: 8F410E0A:E0AC 7F1E020A:520F 01 00000000:00000000 02:00000065 00000000  1001        0 1289244258 2 ffff92c4f700dac0 20 4 30 10 20
  23: 8F410E0A:987A 7A1E020A:520F 01 00000000:00000000 02:00000065 00000000  1001        0 1289244257 2 ffff92c4f700ca40 20 4 30 10 18
  24: 8F410E0A:C99A CEFA030A:192C 06 00000000:00000000 03:0000002E 00000000     0        0 0 3 ffff92bd3633f200
  25: 8F410E0A:C6C2 CEFA030A:192C 06 00000000:00000000 03:00000000 00000000     0        0 0 3 ffff92bed0d11e00
  26: 8F410E0A:CB20 CEFA030A:192C 06 00000000:00000000 03:00000458 00000000     0        0 0 3 ffff92c33d774700
  27: 8F410E0A:C90A CEFA030A:192C 06 00000000:00000000 03:00000000 00000000     0        0 0 3 ffff92c33d774800
  28: 0100007F:822E 0100007F:7B2A 01 00000000:00000000 02:00000118 00000000  1001        0 1289245153 2 ffff92c47c4b2100 20 4 26 10 -1
  29: 8F410E0A:CC6C CEFA030A:192C 06 00000000:00000000 03:000007FA 00000000     0        0 0 3 ffff92c345828300
  30: 8F410E0A:D1E8 CEFA030A:192C 06 00000000:00000000 03:00001689 00000000     0        0 0 3 ffff92c47a32b200
  31: 8F410E0A:D1E6 CEFA030A:192C 06 00000000:00000000 03:00001684 00000000     0        0 0 3 ffff92bed0d10600
  32: 8F410E0A:BCF2 7F1E020A:520F 01 00000000:00000000 02:00000158 00000000  1001        0 1295194237 2 ffff92be427c5280 20 4 1 10 -1
  33: 8F410E0A:C928 901E020A:520F 01 00000000:00000000 02:00000065 00000000  1001        0 1289244260 2 ffff92c4f700c200 20 4 30 9 7
  34: 8F410E0A:1F90 E1060E0A:989C 01 00000000:00000000 02:00000225 00000000  1001        0 1301503332 2 ffff92c3375e5ac0 20 4 29 10 -1
  35: 8F410E0A:CB0A CEFA030A:192C 06 00000000:00000000 03:00000425 00000000     0        0 0 3 ffff92beaf00fe00
  36: 8F410E0A:CFA8 CEFA030A:192C 06 00000000:00000000 03:000010EE 00000000     0        0 0 3 ffff92c47a32b500
'''
    sockets = []

    for line in body.split("\n"):
        line = line.strip()
        if len(line) < 1:
            continue
        sockets.append(line)


    rv = []
    for info in sockets:
        _ = re.split(r'\s+', info)

        _tmp = {
            'seq': _[0],
            'local': convert_linux_netaddr(_[1]),
            'remote': convert_linux_netaddr(_[2]),
            'uid': _[7],
            'timeout': _[8],
            'inode': _[9],
        }
        rv.append(_tmp)

    if len(rv) > 0:
        sys.stdout.write(format_line(title))
        for _ in rv:
            sys.stdout.write(format_line(_))


if __name__ == '__main__':
    main()
